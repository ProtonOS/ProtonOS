# JIT Implementation Gaps

This document tracks gaps found during the comprehensive JIT audit (Dec 2025). Items should be addressed before proceeding with driver development.

## Status Legend
- [ ] Not started
- [x] Complete
- [~] Won't fix (acceptable limitation)

---

## 1. Missing Tests

These are C# features that should work but lack test coverage.

### 1.1 Exception Handling Gaps

- [x] **Divide by zero exception** - INT 0 handler works ✅
  - Tests: TestDivideByZero, TestDivideByZeroModulo (411 tests passing)
  - Verified: DivideByZeroException caught for both / and % operations

- [~] **ckfinite / NaN / Infinity** - Documented limitation (see section 4)
  - Implementation: ckfinite correctly detects NaN/Infinity via exponent check
  - Behavior: Triggers INT3 breakpoint instead of ArithmeticException
  - Reason: Exception allocation complex in JIT context; crash is acceptable

### 1.2 Resource Management

- [x] **IDisposable / using statement** - Dispose pattern ✅
  - Tests: TestUsingStatement, TestUsingWithException, TestNestedUsing (414 tests)
  - Verifies: try/finally generated by compiler, Dispose() called
  - Added IDisposable to WellKnownTypes, interface dispatch working

### 1.3 Iteration Patterns

- [x] **foreach on arrays** - Array iteration ✅
  - Tests: TestForeachIntArray, TestForeachByteArray, TestForeachEmptyArray,
    TestForeachSingleElement, TestForeachLongArray, TestForeachObjectArray,
    TestForeachIterationCount (421 tests)
  - Note: C# optimizes array foreach to indexed access, no IEnumerator used

- [ ] **foreach on custom IEnumerable** - Custom iterator pattern not tested
  - Test: `foreach (var item in customEnumerable) { ... }`
  - Verifies: GetEnumerator(), MoveNext(), Current, Dispose()

- [x] **params arrays** - Explicit array passing works ✅
  - Tests: TestParamsExplicitArray, TestParamsSingleElement, TestParamsEmptyArray,
    TestParamsMixedArgs, TestParamsObjectArray, TestParamsComputedValues,
    TestParamsLength (437 tests)
  - Note: Inline params like `Method(1,2,3)` use RuntimeHelpers.InitializeArray
    which isn't available; use explicit array construction instead

### 1.4 Type System

- [~] **Span<T> / ReadOnlySpan<T>** - Deferred (requires AOT registry for generics)
  - Issue: korlib Span<T> is AOT-compiled but methods not in AOT registry
  - Workaround: Use unsafe pointer patterns instead (MemoryTests)
  - Tests: MemoryTests.TestPointerArrayAccess, TestPointerWrite, TestMemoryFill,
    TestMemoryClear, TestPointerWithOffset, TestBytePointerAccess,
    TestPointerSum, TestStackAlloc, TestPointerComparison (437 tests)
  - Future: Add AOT method registration for generic korlib types

- [ ] **nameof() operator** - Compiles to string literal, should just work
  - Test: `string name = nameof(SomeClass);`
  - Verifies: Compiler generates correct string

### 1.5 Synchronization (Lower Priority)

- [ ] **Interlocked operations** - In PAL but not tested from JIT
  - Test: `Interlocked.Increment(ref counter)`
  - Test: `Interlocked.CompareExchange(ref value, newVal, oldVal)`

---

## 2. Incomplete Implementations

These are implementations that return stubs or have known limitations.

### 2.1 TypedReference (korlib/System/TypedReference.cs)

- [ ] **TypedReference.ToObject for value types** (line 75-77)
  - Current: Returns `null` for value types
  - Needed: Box the value using RhpNewFast
  - Impact: Varargs with value type extraction via ToObject()

### 2.2 Reflection (korlib/System/Reflection/RuntimeReflection.cs)

- [ ] **FieldInfo.FieldType** (line 223)
  - Current: Returns `null`
  - Needed: Resolve field signature to Type
  - Impact: Reflection-based serialization, property grids

- [ ] **PropertyInfo.PropertyType** (line 297)
  - Current: Returns `null`
  - Needed: Resolve property signature to Type
  - Impact: Same as FieldType

- [ ] **MethodInfo.GetParameters()** (line 393)
  - Current: Returns empty `ParameterInfo[]`
  - Needed: Parse method signature, create ParameterInfo for each param
  - Impact: Reflection-based invocation validation

- [ ] **ArgIterator.GetNextArg(RuntimeTypeHandle)** (ArgIterator.cs:70-72)
  - Current: Ignores the type handle parameter
  - Needed: Verify type matches expected
  - Impact: Type-safe varargs iteration

---

## 3. Code TODOs

These are TODO comments found in kernel code that may need attention.

### 3.1 JIT Compiler

| File | Line | TODO |
|------|------|------|
| ILCompiler.cs | 1158 | Parse local signature to get exact type sizes |
| MetadataIntegration.cs | 486 | Point ValueType relatedType to ValueType/Object |

### 3.2 Platform/Drivers (can defer)

| File | Line | TODO |
|------|------|------|
| Timer.cs | 67 | Add RDTSC native wrapper |
| Timer.cs | 78 | Calibrate and return actual TSC frequency |
| Interrupts.cs | 75 | Implement proper RFLAGS check |
| Interrupts.cs | 86 | Implement IRQ allocation from pool |
| Interrupts.cs | 97 | Implement IRQ deallocation |
| Interrupts.cs | 106 | Configure I/O APIC redirection |
| Thread.cs | 169 | Implement thread termination in scheduler |
| Scheduler.cs | 374-376 | Free stack/thread memory, wake waiting threads |
| System.cs | 126 | Get actual CPU count from ACPI/MADT |
| System.cs | 197 | Calculate day of week |
| Arch.cs | 188 | Send EOI to APIC/PIC |

---

## 4. Acceptable Limitations

These are known limitations that are acceptable for the current scope.

- [~] **ckfinite uses INT3** - Triggers breakpoint instead of ArithmeticException
  - Reason: Proper exception requires exception object allocation in restricted context
  - Workaround: Will crash visibly rather than silently corrupt

- [~] **Monitor.Enter/Exit (lock statement)** - Not implemented
  - Reason: Requires full threading synchronization primitives
  - Workaround: Single-threaded execution, use Interlocked for atomics

- [~] **async/await** - Not supported
  - Reason: Requires Task state machine, scheduler integration
  - Workaround: Use synchronous patterns

- [~] **LINQ** - Not supported
  - Reason: Requires extensive BCL (System.Linq)
  - Workaround: Use loops

---

## 5. Priority Order

### P0 - Must fix before drivers ✅ ALL COMPLETE
1. [x] Divide by zero exception test ✅
2. [x] IDisposable / using statement test ✅
3. [x] foreach on arrays test ✅

### P1 - Should fix ✅ ALL COMPLETE
4. [x] Span<T> tests → Memory tests using unsafe pointers (Span deferred - needs AOT registry)
5. [x] params array test (437 tests)
6. [x] ckfinite behavior → Documented as acceptable limitation (INT3 instead of exception)

### P2 - Nice to have
7. [ ] Reflection FieldType/PropertyType/GetParameters
8. [ ] TypedReference.ToObject for value types
9. [ ] foreach on custom IEnumerable

---

## 6. Test Locations

New tests should be added to `src/FullTest/Program.cs`:

```csharp
// Exception tests
public static class ExceptionTests { ... }

// Resource management tests
public static class DisposableTests { ... }

// Iterator tests
public static class IteratorTests { ... }

// Span tests
public static class SpanTests { ... }
```

---

## Completion Tracking

| Category | Total | Done | Remaining |
|----------|-------|------|-----------|
| Missing Tests | 9 | 6 | 3 |
| Incomplete Impl | 5 | 0 | 5 |
| Code TODOs (JIT) | 2 | 0 | 2 |
| Code TODOs (Platform) | 11 | 0 | 11 |
| **P0 Items** | **3** | **3** | **0** |
| **P1 Items** | **3** | **3** | **0** |

Last updated: 2025-12-14
Test count: 437

## Recent Changes

### P1 Completion (437 tests)
- Added MemoryTests (pointer-based tests for span-like operations)
- Added ParamsTests (explicit array passing to params methods)
- Documented ckfinite as acceptable limitation (INT3 instead of ArithmeticException)
- Added Span`1 and ReadOnlySpan`1 to WellKnownTypes (0xF0000060, 0xF0000061)
- Added kernel metadata fallback for well-known JIT types (partial)

### P0 Completion (421 tests)
- Added IDisposable to WellKnownTypes (0xF0000050)
- Added IDisposable MT registration and retrieval in MetadataIntegration
- Fixed interface dispatch for well-known interfaces
- Added 3 DisposableTests (TestUsingStatement, TestUsingWithException, TestNestedUsing)
- Added 7 ForeachTests for array iteration
